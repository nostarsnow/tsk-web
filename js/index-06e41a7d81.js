"use strict";$(function(){function e(){var e=$(".upload"),n=$("#upload"),t=$(".test a"),a=$("main h1 a");e.on("dragover",function(e){e.preventDefault()}).on("drop",function(e){e.preventDefault();var n=e.dataTransfer.files[0];o(n)}),n.on("change",function(e){var n=this.files[0];o(n)}),a.on("click",function(e){window.location.href=window.location.href}),t.on("click",function(e){ns.load();var n=new XMLHttpRequest;n.open("GET","./json/Default.db",!0),n.responseType="arraybuffer",n.onload=function(e){var n=new Uint8Array(this.response),t=new window.SQL.Database(n),a=t.exec("select * from trackrecord123 order by timestamp");i(a[0].values),ns.loadHide()},n.setRequestHeader("Content-Type","text/xml"),n.send()}),ns.ajax("./json/nick.json",{},{load:!1,lock:!1}).then(function(e){window.opt.nick=e})}function n(){var e=$(".page2-data"),n=$("#tpl-page2-data"),o=$(".toDetail");e.html(ns.tpl(n.html(),window.opt.data)),o.on("click",function(){window.opt.page3Init?(p.hide(),l.fadeIn()):t()}),e.on("click","tbody tr",function(){var e=$(this).attr("data-name")||"",n=$(this).attr("data-role")||"";if(e&&(window.opt.search.p1Name=e),n&&(window.opt.search.p1Role=n),window.opt.page3Init){var o=$("#p1Names"),i=$("#p1Roles");o.val(e).trigger("change"),i.val(n),p.hide(),l.fadeIn()}else t();a()}),p.hide(),r.fadeIn()}function t(){var e=$("#p1Names"),n=$("#p1Roles"),t=$("#p2Names"),o=$("#p2Roles"),i=$("#tpl-p1Names"),s=$("#tpl-p1Roles"),d=$("#tpl-p2Names"),c=$("#tpl-p2Roles"),f=$(".search"),u=$(".back");e.html(ns.tpl(i.html(),window.opt.data)).on("change",function(t){var a=e.val(),o={};window.opt.search.p1Name=a,""===a?o.data=window.opt.data.p1Roles.map(function(e){return e.role}):o.data=window.opt.data.p1Names[a].roles,n.html(ns.tpl(s.html(),o)).val("")}).val(window.opt.search.p1Name).trigger("change"),t.html(ns.tpl(d.html(),window.opt.data)).on("change",function(e){var n=t.val(),a={};window.opt.search.p2Name=n,""===n?a.data=window.opt.data.p2Roles.concat([]).sort(function(e,n){return e-n}):a.data=window.opt.data.p2Names[n].roles.concat([]).sort(function(e,n){return e-n}),o.html(ns.tpl(c.html(),a)).val("")}).val(window.opt.search.p2Name).trigger("change"),n.on("change",function(e){var t=n.val();window.opt.search.p1Role=t}).val(window.opt.search.p1Role),o.on("change",function(e){var n=o.val();window.opt.search.p2Role=n}).val(window.opt.search.p2Role),f.on("click",a),u.on("click",function(){p.hide(),r.fadeIn()}),p.hide(),l.fadeIn(),window.opt.page3Init=!0,a()}function a(){var e=window.opt,n=e.search,t=e.data,a=t.list,o=t.p1Names,i=t.p2Names,p=""!==n.p1Name?o[n.p1Name].name:"",r=n.p1Role,l=""!==n.p2Name?i[n.p2Name].name:"",s=""!==n.p2Name?i[n.p2Name].nick:"",d=n.p2Role,c=""===p,f=""===r,u=""===l,w=""===d,m=[],h={total:0,p1Win:0,p2Win:0,v02:0,v12:0,v21:0,v20:0},v=0,g=a.filter(function(e){var n=(c||e.p1Name===p)&&(f||e.p1Role===+r)&&(u||e.p2Name===l)&&(w||e.p2Role===+d);if(n){var t=m.findIndex(function(n){return n.text===e.date});t>-1?m[t].list.push(v):m.push({text:e.date,list:[v]}),v++}return n});if(0===g.length)return ns.tip("没有筛选条件的对局信息！"),!1;m.forEach(function(e,n){e.total=e.list.length,h.total+=e.total,e.p1Win=0,e.p2Win=0,e.v02=0,e.v12=0,e.v20=0,e.v21=0,e.list.forEach(function(n){g[n].p1Win&&(e.p1Win++,h.p1Win++),g[n].p2Win&&(e.p2Win++,h.p2Win++),0===g[n].p1WinNum&&(e.v02++,h.v02++),1===g[n].p1WinNum&&(e.v12++,h.v12++),1===g[n].p2WinNum&&(e.v21++,h.v21++),0===g[n].p2WinNum&&(e.v20++,h.v20++)}),e.p1WinPer=ns.getPercent(e.p1Win,e.total)}),h.p1WinPer=ns.getPercent(h.p1Win,h.total);var N={tooltip:{formatter:function(e){var n=e[0]||e;return(n.axisValue?n.axisValue+"日":"")+"胜率<br/>"+n.data.w+"/"+n.data.t+"="+n.data.value+"%"}},backgroundColor:"#eee",grid:{top:30,bottom:80,left:40,right:40},xAxis:{type:"category",data:m.map(function(e){return e.text}),boundaryGap:!0,axisLine:{},axisLabel:{interval:0,rotate:45,fontSize:13,color:"#777"},axisTick:{alignWithLabel:!0},splitArea:{},axisPointer:{show:!0}},yAxis:{type:"value",min:0,max:100,splitLine:{}},toolbox:{show:!0},series:[{data:m.map(function(e){return{name:"胜率",value:e.p1WinPer,w:e.p1Win,t:e.total}}),type:"line",symbolSize:7,label:{show:!(m.length>20),position:"top",fontSize:14,color:"#333",fontWeight:"bold",formatter:function(e){return e.data.value+"%"}},markLine:{silent:!0,data:[{name:"平均线",yAxis:"50"}]}}]},R=$(".page3 .title"),W=$("#tpl-title"),x=$("#canvas"),y={begin:g[0].date,end:g[g.length-1].date,days:m.length,offset:ns.getDayOffset(g[0].date,g[g.length-1].date)};R.html(ns.tpl(W.html(),{result:h,p1Name:p,p2Name:l,p1Role:""!==r?window.opt.role[r].n:"",p2Role:""!==d?window.opt.role[d].n:"",p2Nick:s,dayData:y})),window.opt.chart=echarts.init(x[0]),window.opt.chart.setOption(N)}function o(e){ns.load();var n=new FileReader;n.onload=function(){var e=new Uint8Array(n.result),t=new window.SQL.Database(e),a=t.exec("select * from trackrecord123 order by timestamp");i(a[0].values)},n.readAsArrayBuffer(e)}function i(e){for(var t=[],a=[],o=[],i=[],p=[],r=[],l=0,s=0,d=function(n){var d={},c=e[n],m=ns.formatDate(ns.tickToTime(c[0]));if(d={p1Name:c[1],p1Role:c[2],p1WinNum:c[3],p2Name:c[4],p2Role:c[5],p2WinNum:c[6],p1Win:!!(c[3]>c[6]),p2Win:!!(c[3]<c[6]),time:m.str,date:ns.formatDate(ns.tickToTime(c[0])+window.opt.timeOffset,"yyyy-MM-dd").str,dict:m.dict},s++,l+=~~d.p1Win,f=a.findIndex(function(e){return e.name===d.p1Name}),f===-1)a.push({name:d.p1Name,win:~~d.p1Win,total:1,roles:[d.p1Role]});else{a[f].total++,a[f].win+=~~d.p1Win;var h=a[f].roles.findIndex(function(e){return e===d.p1Role});h===-1&&a[f].roles.push(d.p1Role)}if(u=o.findIndex(function(e){return e.role===d.p1Role}),u===-1?o.push({role:d.p1Role,win:~~d.p1Win,total:1}):(o[u].total++,o[u].win+=~~d.p1Win),w=i.findIndex(function(e){return e.name===d.p2Name}),w===-1)i.push({name:d.p2Name,win:~~d.p1Win,total:1,roles:[d.p2Role]});else{i[w].total++,i[w].win+=~~d.p1Win;var v=i[w].roles.findIndex(function(e){return e===d.p2Role});v===-1&&i[w].roles.push(d.p2Role)}p.findIndex(function(e){return e===d.p2Role})===-1&&p.push(d.p2Role),r.findIndex(function(e){return e===d.date})===-1&&r.push(d.date),t.push(d)},c=0;c<e.length;c++){var f,u,w;d(c)}a.forEach(function(e){e.winPercent=ns.getPercent(e.win,e.total),e.name=e.name}),o.forEach(function(e){e.winPercent=ns.getPercent(e.win,e.total)}),i.forEach(function(e){var n=window.opt.nick.findIndex(function(n){return n.n===e.name});n!==-1&&(e.nick=window.opt.nick[n].v)}),window.opt.data={list:t,p1Names:a,p1Roles:o,p2Names:i,p2Roles:p,days:r,dayData:{begin:r[0],end:r[r.length-1],days:r.length,offset:ns.getDayOffset(r[0],r[r.length-1])},winPercent:ns.getPercent(l,s)},ns.loadHide(),n()}window.opt={role:["灵梦","魔理沙","咲夜","爱丽丝","帕秋莉","妖梦","雷米利亚","幽幽子","紫","萃香","铃仙","文","小町","衣玖","天子","早苗","琪露诺","美铃","空","诹访子"].reduce(function(e,n,t){return e[t]={n:n},e},{}),search:{p1Name:"",p1Role:"",p2Name:"",p2Role:""},timeOffset:-18e6};var p=$(".page"),r=($(".page1"),$(".page2")),l=$(".page3");$(".page4");e()});