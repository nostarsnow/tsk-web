"use strict";$(function(){function e(){var e=$(".upload"),n=$("#upload"),t=$(".test a"),a=$("main h1 a"),r=$(".particle-bg");e.on("dragover",function(e){e.preventDefault()}).on("drop",function(e){e.preventDefault();var n=e.dataTransfer.files[0];return o(n),!1}),n.on("change",function(e){var n=this.files[0];o(n)}),a.on("click",function(e){window.location.href=window.location.href}),t.on("click",function(e){ns.load();var n=new XMLHttpRequest;n.open("GET",window.opt.json.db,!0),n.responseType="arraybuffer",n.onload=function(e){var n=new Uint8Array(this.response),t=new window.SQL.Database(n),a=t.exec("select * from trackrecord123 order by timestamp");i(a[0].values),ns.loadHide()},n.setRequestHeader("Content-Type","text/xml"),n.send()}),ns.ajax(window.opt.json.nick,{},{load:!1,lock:!1}).then(function(e){window.opt.nick=e});var p={particleColor:"#a58e64",background:"transparent",interactive:!0,speed:"slow",density:"medium"};window.opt.particleCanvas=new ParticleNetwork(r[0],p)}function n(){var e=$(".page2-data"),n=$("#tpl-page2-data");e.html(ns.tpl(n.html(),window.opt.data));var o=$(".toDetail"),i=e.find("table");o.on("click",function(){window.opt.page3Init?(r.hide(),l.fadeIn()):t()}),e.on("click","tbody tr",function(){var e=$(this).attr("data-name")||"",n=$(this).attr("data-role")||"";if(e&&(window.opt.search.p1Name=e),n&&(window.opt.search.p1Role=n),window.opt.page3Init){var o=$("#p1Names"),i=$("#p1Roles");o.val(e).trigger("change"),i.val(n),r.hide(),l.fadeIn()}else t();a()}),i.tablesort().data("tablesort"),i.find("thead th.number").data("sortBy",function(e,n,t){return parseInt(n.text(),10)}),r.hide(),p.fadeIn()}function t(){var e=$("#p1Names"),n=$("#p1Roles"),t=$("#p2Names"),o=$("#p2Roles"),i=$("#tpl-p1Names"),s=$("#tpl-p1Roles"),d=$("#tpl-p2Names"),c=$("#tpl-p2Roles"),u=$(".search"),m=$(".back");e.html(ns.tpl(i.html(),window.opt.data)).on("change",function(t){var a=e.val(),o={};window.opt.search.p1Name=a,""===a?o.data=window.opt.data.p1Roles.map(function(e){return e.role}):o.data=window.opt.data.p1Names[a].roles,n.html(ns.tpl(s.html(),o)).val("")}).val(window.opt.search.p1Name).trigger("change"),t.html(ns.tpl(d.html(),window.opt.data)).on("change",function(e){var n=t.val(),a={};window.opt.search.p2Name=n,""===n?a.data=window.opt.data.p2Roles.concat([]).sort(function(e,n){return e-n}):a.data=window.opt.data.p2Names[n].roles.concat([]).sort(function(e,n){return e-n}),o.html(ns.tpl(c.html(),a)).val(""),window.opt.search.p2Role=""}).val(window.opt.search.p2Name).trigger("change"),n.on("change",function(e){var t=n.val();window.opt.search.p1Role=t}).val(window.opt.search.p1Role),o.on("change",function(e){var n=o.val();window.opt.search.p2Role=n}).val(window.opt.search.p2Role),u.on("click",a),m.on("click",function(){r.hide(),p.fadeIn()}),r.hide(),l.fadeIn(),window.opt.page3Init=!0,a()}function a(){var e=window.opt,n=e.search,t=e.data,a=t.list,o=t.p1Names,i=t.p2Names,r=""!==n.p1Name?o[n.p1Name].name:"",p=n.p1Role,l=""!==n.p2Name?i[n.p2Name].name:"",s=""!==n.p2Name?i[n.p2Name].nick:"",d=n.p2Role,c=""===r,u=""===p,m=""===l,f=""===d,w=[],h={total:0,p1Win:0,p2Win:0,v02:0,v12:0,v21:0,v20:0},v=0,g=a.filter(function(e){var n=(c||e.p1Name===r)&&(u||e.p1Role===+p)&&(m||e.p2Name===l)&&(f||e.p2Role===+d);if(n){var t=w.findIndex(function(n){return n.text===e.date});t>-1?w[t].list.push(v):w.push({text:e.date,list:[v]}),v++}return n});if(0===g.length)return ns.tip("没有筛选条件的对局信息！"),!1;w.forEach(function(e,n){e.total=e.list.length,h.total+=e.total,e.p1Win=0,e.p2Win=0,e.v02=0,e.v12=0,e.v20=0,e.v21=0,e.p2Names=[],e.list.forEach(function(n){var t=e.p2Names.findIndex(function(e){return e.name===g[n].p2NameNum});t===-1?(e.p2Names.push({name:g[n].p2NameNum,p1Win:0,p2Win:0,total:1}),t=e.p2Names.length-1):e.p2Names[t].total++,g[n].p1Win&&(e.p1Win++,h.p1Win++,e.p2Names[t].p1Win++),g[n].p2Win&&(e.p2Win++,h.p2Win++,e.p2Names[t].p2Win++),0===g[n].p1WinNum&&(e.v02++,h.v02++),1===g[n].p1WinNum&&(e.v12++,h.v12++),1===g[n].p2WinNum&&(e.v21++,h.v21++),0===g[n].p2WinNum&&(e.v20++,h.v20++)}),e.p2Names.forEach(function(e){e.p1WinPer=ns.getPercent(e.p1Win,e.total)}),e.p1WinPer=ns.getPercent(e.p1Win,e.total)}),h.p1WinPer=ns.getPercent(h.p1Win,h.total);var N={tooltip:{formatter:function(e){var n=e[0]||e,t="",a=window.opt.data.p2Names;return n.data.p2Names.forEach(function(e){var n=a[e.name];t+="<br/>"+n.name+(n.nick?"（"+n.nick+"）":"")+"："+e.p1Win+"/"+e.total+"="+e.p1WinPer+"%"}),"\n            <b>"+(n.axisValue?n.axisValue+"日":"")+"</b>胜率<br/>\n            <b>当天所有对战</b> "+n.data.w+"/"+n.data.t+"="+n.data.value+"%<br/>\n            <b>对战详情</b>\n            "+t+"\n          "},axisPointer:{type:"cross"},trigger:"axis"},backgroundColor:"#eee",grid:{top:50,bottom:80,left:40,right:40},xAxis:{type:"category",data:w.map(function(e){return e.text}),boundaryGap:!0,axisLine:{},axisLabel:{interval:0,rotate:45,fontSize:13,color:"#777"},axisTick:{alignWithLabel:!0},splitArea:{},axisPointer:{show:!0}},dataZoom:function(e){return e.length-window.opt.dataZoomLength>5?[{type:"slider",show:!0,xAxisIndex:[0],startValue:e.length-window.opt.dataZoomLength,endValue:e.length-1}]:[{type:"slider",show:!1,xAxisIndex:[0],startValue:0,endValue:e.length-1}]}(w),yAxis:{type:"value",min:0,max:100,splitLine:{}},toolbox:{show:!0,feature:{restore:{},magicType:{type:["line","bar"]}}},series:[{data:w.map(function(e){return{name:"胜率",value:e.p1WinPer,w:e.p1Win,t:e.total,p2Names:e.p2Names||[]}}),type:"line",symbolSize:7,label:{show:!(w.length>20),position:"top",fontSize:14,color:"#333",fontWeight:"bold",formatter:function(e){return e.data.value+"%"}},markLine:{silent:!0,data:[{name:"中间线",yAxis:"50",lineStyle:{color:"#aaa"}},{name:"平均线",yAxis:h.p1WinPer,lineStyle:{color:"#777"}}]}}]},x=$(".page3 .title"),W=$("#tpl-title"),y=$("#canvas"),b={begin:g[0].date,end:g[g.length-1].date,days:w.length,offset:ns.getDayOffset(g[0].date,g[g.length-1].date)};x.html(ns.tpl(W.html(),{result:h,p1Name:r,p2Name:l,p1Role:""!==p?window.opt.role[p].n:"",p2Role:""!==d?window.opt.role[d].n:"",p2Nick:s,dayData:b})),window.opt.chart=echarts.init(y[0]),window.opt.chart.setOption(N)}function o(e){if(e.suffixType=e.name.match(/.+\.(.*)/)[1].toLowerCase(),"db"!==e.suffixType)return ns.tip("请上传正确的.db文件格式！"),!1;ns.load();var n=new FileReader;n.onload=function(){var e=new Uint8Array(n.result),t=new window.SQL.Database(e),a=t.exec("select * from trackrecord123 order by timestamp");i(a[0].values)},n.readAsArrayBuffer(e)}function i(e){for(var t=[],a=[],o=[],i=[],r=[],p=[],l=0,s=0,d=function(n){var d={},c=e[n],w=ns.formatDate(ns.tickToTime(c[0]));if(d={p1Name:String(c[1]).trim(),p1Role:c[2],p1WinNum:c[3],p2Name:String(c[4]).trim(),p2Role:c[5],p2WinNum:c[6],p1Win:!!(c[3]>c[6]),p2Win:!!(c[3]<c[6]),time:w.str,date:ns.formatDate(ns.tickToTime(c[0])+window.opt.timeOffset,"yyyy-MM-dd").str,dict:w.dict},s++,l+=~~d.p1Win,u=a.findIndex(function(e){return e.name===d.p1Name}),u===-1)a.push({name:d.p1Name,win:~~d.p1Win,total:1,roles:[d.p1Role]});else{a[u].total++,a[u].win+=~~d.p1Win;var h=a[u].roles.findIndex(function(e){return e===d.p1Role});h===-1&&a[u].roles.push(d.p1Role)}if(m=o.findIndex(function(e){return e.role===d.p1Role}),m===-1?o.push({role:d.p1Role,win:~~d.p1Win,total:1}):(o[m].total++,o[m].win+=~~d.p1Win),f=i.findIndex(function(e){return e.name===d.p2Name}),f===-1)i.push({name:d.p2Name,win:~~d.p1Win,total:1,roles:[d.p2Role]}),f=i.length-1;else{i[f].total++,i[f].win+=~~d.p1Win;var v=i[f].roles.findIndex(function(e){return e===d.p2Role});v===-1&&i[f].roles.push(d.p2Role)}r.findIndex(function(e){return e===d.p2Role})===-1&&r.push(d.p2Role),p.findIndex(function(e){return e===d.date})===-1&&p.push(d.date),d.p2NameNum=f,t.push(d)},c=0;c<e.length;c++){var u,m,f;d(c)}a.forEach(function(e){e.winPercent=ns.getPercent(e.win,e.total),e.name=e.name}),o.forEach(function(e){e.winPercent=ns.getPercent(e.win,e.total)}),i.forEach(function(e){var n=window.opt.nick.findIndex(function(n){return n.n===e.name});n!==-1&&(e.nick=window.opt.nick[n].v)}),window.opt.data={list:t,p1Names:a,p1Roles:o,p2Names:i,p2Roles:r,days:p,dayData:{begin:p[0],end:p[p.length-1],days:p.length,offset:ns.getDayOffset(p[0],p[p.length-1])},winPercent:ns.getPercent(l,s)},ns.loadHide(),n()}window.opt={role:["灵梦","魔理沙","咲夜","爱丽丝","帕秋莉","妖梦","雷米利亚","幽幽子","紫","萃香","铃仙","文","小町","衣玖","天子","早苗","琪露诺","美铃","空","诹访子"].reduce(function(e,n,t){return e[t]={n:n},e},{}),search:{p1Name:"",p1Role:"",p2Name:"",p2Role:""},timeOffset:-18e6,dataZoomLength:30,json:{nick:"./json/nick.json",db:"./json/Default.db"}};var r=$(".page"),p=($(".page1"),$(".page2")),l=$(".page3");$(".page4");e()});